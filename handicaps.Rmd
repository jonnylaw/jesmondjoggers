---
title: "Handicaps"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(kableExtra)
library(lubridate)
theme_set(theme_minimal())
```

```{r all_results, cache=FALSE}
source("scripts/read_results.R", )
```

```{r format_handicaps}
calculate_handicaps() %>%
  knitr::kable(format = "html", booktabs = T, 
               col.names = c("5k Season's Best", "Previous Race Time", "Your Handicap Time")) %>% 
  kable_styling(latex_options = "striped")
```

```{r best-results, results='asis'}
best_results = all_results %>%
  mutate(time = running_time) %>%
  group_by(first_name, second_name) %>%
  summarise(time = min(time))

best_results$pretty_time = lubridate::seconds_to_period(best_results$time)
```

```{r average-results}
average_results = all_results %>%
  mutate(time = running_time) %>%
  group_by(first_name, second_name) %>%
  summarise(time = mean(time))
```

## New Handicaps

```{r calculate-new-handicaps}
# Get current handicaps from 5k PB
current_handicaps = calculate_handicaps() %>%
  mutate(handicap = period_to_seconds(handicap_time)) %>% 
  .$handicap

# Round the raw handicap (longest_run - your_run_time) to one of the current handicaps
round_to_handicap = function(new_handicap_time, current_handicaps) {
  i = which.min(abs(new_handicap_time - current_handicaps))
  current_handicaps[i]
}

# Calculate the longest run of all runs
longest_run = max(average_results$time)

# Calculate new handicaps
new_handicaps = average_results %>%
  mutate(new_handicap_raw = longest_run - time) %>%
  rowwise() %>%
  mutate(new_handicap = round_to_handicap(new_handicap_raw, current_handicaps)) %>%
  mutate(group = cut(new_handicap_raw, breaks = c(0, 360, 520, 1000), labels = 1:3, include.lowest = T)) %>%
  select(first_name, second_name, new_handicap, group) %>%
  arrange(new_handicap)

new_handicaps$new_handicap = seconds_to_period(new_handicaps$new_handicap)
```

```{r display-new-handicaps}
# Display new handicaps by time
new_handicaps %>%
  knitr::kable(format = "html", booktabs = T, col.names = c("First", "Second", "Handicap", "group")) %>% 
  kable_styling(latex_options = "striped")
```